# React Native BB Player - Build Configuration

## CRITICAL: Release Policy

**A new npm release is ONLY triggered when a git TAG is pushed.**

**NEVER create or push git tags unless the user EXPLICITLY asks for a release.**

- Pushing commits to any branch (including `master` or `release/*`) does NOT trigger a release
- Only pushing a tag matching `v*.*.*` triggers the `release.yml` workflow → npm publish
- Tags are created via the `create-release.yml` workflow (run manually from a release branch)

**Workflow:**
1. `create-release-branch.yml` - Creates release branches (e.g., `release/v8.43`)
2. `create-release.yml` - Creates version tags from release branches (ONLY when explicitly requested)
3. `release.yml` - Publishes to npm when tags are pushed

**DO NOT run `create-release.yml` or push tags without explicit user request.**

## Overview

This is a **pure React Native native module** (not Expo) for the Blue Billywig Native Video Player SDK.

**Architecture**: ViewManager + NativeModule pattern
- `BBPlayerViewManager` - Renders the native player view
- `BBPlayerModule` - Handles commands (play, pause, etc.) via NativeModule
- Works with both Old Architecture (Paper) and New Architecture (Fabric)

## Build Environment

### Java Version
- **Required**: Java 17
- **Set via**: `export JAVA_HOME=/path/to/jdk-17`

### Android SDK
- **Set via**: `export ANDROID_HOME=~/Library/Android/sdk`

## Native SDK Versions

### Android
- **BB Native Player SDK**: `8.42.+` (flexible patch version)
- **Location**: `android/build.gradle`
- **Maven repo**: `https://maven.bluebillywig.com/releases`

### iOS
- **BB Native Player Kit**: `~> 8.40.0`
- **Location**: `react-native-bb-player.podspec`

## Project Structure

```
react-native-bb-player/
├── android/
│   └── src/main/java/com/bluebillywig/bbplayer/
│       ├── BBPlayerPackage.kt      # ReactPackage - registers module & view manager
│       ├── BBPlayerModule.kt       # NativeModule for commands
│       ├── BBPlayerViewManager.kt  # ViewManager for native view
│       └── BBPlayerView.kt         # Native Android view
├── ios/
│   ├── BBPlayerViewManager.m       # RCTViewManager
│   ├── BBPlayerView.swift          # Native iOS view
│   └── ...
├── src/
│   ├── index.ts                    # Main exports
│   ├── BBPlayerView.tsx            # React component wrapper
│   ├── NativeCommands.ts           # Command dispatch via NativeModule
│   └── BBPlayer.types.ts           # TypeScript types
├── lib/                            # Built output (generated by bob build)
├── example/                        # Bare React Native example app
└── react-native-bb-player.podspec  # iOS CocoaPods spec
```

## Clean Build Process

### Step 1: Build TypeScript
Always rebuild TypeScript first when source files change:

```bash
npm run build
```

This compiles `src/` to `lib/` (commonjs, module, typescript).

### Step 2: Build Android Release APK

```bash
cd example/android

# Set Java 17
export JAVA_HOME=/path/to/jdk-17

# Clean build (recommended after native code changes)
./gradlew clean assembleRelease

# Or incremental build
./gradlew assembleRelease
```

**Output**: `example/android/app/build/outputs/apk/release/app-release.apk`

### Step 3: Install and Test

```bash
# Install on connected device/emulator
adb install -r example/android/app/build/outputs/apk/release/app-release.apk

# Launch app
adb shell am start -n com.bbplayerexample/.MainActivity

# View logs
adb logcat | grep -E "(BBPlayer|ReactNativeJS)"
```

## Full Rebuild (After Native Code Changes)

When you modify native Kotlin/Swift code:

```bash
# 1. Build TypeScript
npm run build

# 2. Clean and rebuild Android
cd example/android
export JAVA_HOME=/path/to/jdk-17
./gradlew clean assembleRelease

# 3. Install
adb install -r app/build/outputs/apk/release/app-release.apk
```

## Architecture Notes

### Command Dispatch (New Architecture Compatible)

Commands use NativeModule pattern instead of `UIManager.dispatchViewManagerCommand`:

```typescript
// src/NativeCommands.ts
const { BBPlayerModule } = NativeModules;

export function createCommands(viewRef) {
  return {
    play: () => {
      const tag = findNodeHandle(viewRef.current);
      BBPlayerModule?.play(tag);
    },
    // ...
  };
}
```

```kotlin
// android/BBPlayerModule.kt
@ReactMethod
fun play(viewTag: Int) {
    runOnUiThread(viewTag) { it.play() }
}

private fun findPlayerView(viewTag: Int): BBPlayerView? {
    // Try Fabric first, then Paper
    val fabricView = UIManagerHelper.getUIManager(reactContext, UIManagerType.FABRIC)
        ?.resolveView(viewTag)
    if (fabricView is BBPlayerView) return fabricView

    val paperView = UIManagerHelper.getUIManager(reactContext, UIManagerType.DEFAULT)
        ?.resolveView(viewTag)
    if (paperView is BBPlayerView) return paperView

    return null
}
```

### New Architecture Support

The example app has New Architecture enabled by default (`newArchEnabled=true` in `gradle.properties`).
The module supports both:
- **Fabric** (New Architecture) - Uses `UIManagerType.FABRIC`
- **Paper** (Old Architecture) - Uses `UIManagerType.DEFAULT`

## Common Issues

### 1. JS Bundle Not Updated
If changes don't appear, the JS bundle may be cached:
```bash
cd example/android
./gradlew clean assembleRelease  # Full clean rebuild
```

### 2. TypeScript Not Compiled
Always run `npm run build` in the root before building Android:
```bash
npm run build
```

### 3. Module Not Found
Ensure the module is properly linked via autolinking in `example/node_modules/@bluebillywig/react-native-bb-player`.

### 4. Commands Not Working
- Check logcat for `BBPlayerModule` logs
- Verify `findNodeHandle` returns a valid tag
- Ensure view is mounted before calling commands

## iOS Build Process

### CRITICAL: CocoaPods & Ruby Architecture

**NEVER use `sudo gem install` for CocoaPods.** The system/Homebrew Ruby installations may have architecture issues.

**Known issue:** Homebrew Ruby (`/usr/local/Cellar/ruby/`) is often x86_64 only, causing CocoaPods to run under Rosetta even on arm64 Macs. This causes confusing "Do not use pod install from inside Rosetta2" warnings that persist regardless of `arch -arm64` wrappers.

### Step 1: Install iOS Dependencies

```bash
cd example/ios

# Clean previous attempts
rm -rf Pods Podfile.lock build ~/Library/Caches/CocoaPods

# Run pod install (see troubleshooting below if this fails)
LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 pod install
```

### Step 2: Build iOS Release IPA

```bash
cd example/ios

# Build for device (Release)
xcodebuild -workspace BBPlayerExample.xcworkspace \
  -scheme BBPlayerExample \
  -configuration Release \
  -destination 'generic/platform=iOS' \
  -archivePath build/BBPlayerExample.xcarchive \
  archive

# Export IPA (requires valid signing identity)
xcodebuild -exportArchive \
  -archivePath build/BBPlayerExample.xcarchive \
  -exportPath build/ipa \
  -exportOptionsPlist ExportOptions.plist
```

### Step 3: Install on Device

```bash
# Install via Xcode (open archive)
open build/BBPlayerExample.xcarchive

# Or via ios-deploy
ios-deploy --bundle build/ipa/BBPlayerExample.ipa
```

### Troubleshooting pod install

**UTF-8 Encoding Error:**
```
Unicode Normalization not appropriate for ASCII-8BIT
```
Fix: Always set `LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8` before running pod commands.

**Rosetta Warning (even with arm64):**
```
Do not use "pod install" from inside Rosetta2
```
This usually means the Ruby binary itself is x86_64. Check with:
```bash
file $(which ruby)  # Should show arm64 or universal
file /usr/local/Cellar/ruby/*/bin/ruby  # Homebrew Ruby - often x86_64
```
If Homebrew Ruby is x86_64, use system Ruby or install arm64 Ruby via rbenv/rvm.

**Podspec Not Found:**
```
CocoaPods could not find compatible versions for pod "react-native-bb-player"
```
Ensure the podspec version matches available BlueBillywigNativePlayerKit versions:
```bash
pod search BlueBillywigNativePlayerKit-iOS
# Update version in react-native-bb-player.podspec if needed
```

## Metro Configuration

The example app's `metro.config.js` is configured to:
1. Watch the SDK source folder (`..`)
2. Block nested `node_modules` to prevent duplicate dependencies
3. Resolve dependencies from example's `node_modules` only
