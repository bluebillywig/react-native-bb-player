name: Create release tag

on:
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.create_tag.outputs.RELEASE_TAG }}
      release_version: ${{ steps.validate.outputs.RELEASE_VERSION }}
      upload_url: ${{ steps.create_github_release.outputs.upload_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set commit credentials
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Validate release branch
        id: validate
        run: |
          CURRENT_BRANCH="${GITHUB_REF##refs/heads/}"

          if [[ "$CURRENT_BRANCH" =~ ^release/v([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            RELEASE_BRANCH="release/v${MAJOR}.${MINOR}"

            # Get patch version from package.json
            PATCH=$(grep '"version"' package.json | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | cut -d. -f3)
            RELEASE_VERSION="${MAJOR}.${MINOR}.${PATCH}"

            echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
            echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
            echo "RELEASE_BRANCH=${RELEASE_BRANCH}" >> $GITHUB_ENV
            echo "Creating release from branch: $RELEASE_BRANCH (version: $RELEASE_VERSION)"
          else
            echo "::error::Not on a release branch. Current branch: $CURRENT_BRANCH"
            echo "::error::This workflow must be run from a release/v{x}.{y} branch"
            exit 1
          fi

      - name: Check if tag already exists
        run: |
          RELEASE_TAG="${{ env.RELEASE_VERSION }}"

          if git rev-parse "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "::error::Tag $RELEASE_TAG already exists"
            exit 1
          fi

          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV

      - name: Get previous tag for changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 --match='*.*.*' 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "FROM_TAG=${PREV_TAG}" >> $GITHUB_ENV
          echo "Generating changelog from: $PREV_TAG"

      - name: Extract changelog section
        id: changelog
        run: |
          VERSION="${{ env.RELEASE_VERSION }}"
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d')
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="See CHANGELOG.md for details"
            fi
          else
            CHANGELOG="Version $VERSION release"
          fi
          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "CHANGELOG_FILE=/tmp/changelog.txt" >> $GITHUB_ENV

      - name: Create tag
        id: create_tag
        run: |
          git tag "${{ env.RELEASE_TAG }}"
          git push origin "${{ env.RELEASE_TAG }}"
          echo "RELEASE_TAG=${{ env.RELEASE_TAG }}" >> $GITHUB_OUTPUT
          echo "âœ… Created and pushed tag: ${{ env.RELEASE_TAG }}"

      - name: Extract native SDK versions
        id: sdk_versions
        run: |
          IOS_VERSION=$(grep "s.dependency 'BlueBillywigNativePlayerKit-iOS'" ReactNativeBBPlayer.podspec | grep -oE "[0-9]+\.[0-9]+\.[0-9]+")
          ANDROID_VERSION=$(grep "com.bluebillywig.bbnativeplayersdk:bbnativeplayersdk" android/build.gradle | grep -oE "[0-9]+\.[0-9]+")
          echo "IOS_SDK_VERSION=${IOS_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_SDK_VERSION=${ANDROID_VERSION}" >> $GITHUB_ENV

      - name: Create GitHub Release
        id: create_github_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: 'Release ${{ env.RELEASE_VERSION }}'
          body: |
            ## react-native-bb-player ${{ env.RELEASE_VERSION }}

            $(cat ${{ env.CHANGELOG_FILE }})

            ## Native SDK Versions
            - **iOS**: BlueBillywigNativePlayerKit-iOS `${{ env.IOS_SDK_VERSION }}`
            - **Android**: bbnativeplayersdk `${{ env.ANDROID_SDK_VERSION }}`

            ## Installation

            ```bash
            npm install react-native-bb-player@${{ env.RELEASE_VERSION }}
            ```

            Or with specific version:

            ```json
            {
              "dependencies": {
                "react-native-bb-player": "${{ env.RELEASE_VERSION }}"
              }
            }
            ```

            ## Download Demo App

            ðŸ“± Try the demo app to test video playback:
            - [player-api-example.apk](https://github.com/bluebillywig/react-native-bb-player/releases/download/${{ env.RELEASE_TAG }}/player-api-example-${{ env.RELEASE_VERSION }}.apk) - Android demo app

            ## Package Files

            ðŸ“¦ Direct package download:
            - [react-native-bb-player-${{ env.RELEASE_VERSION }}.tgz](https://github.com/bluebillywig/react-native-bb-player/releases/download/${{ env.RELEASE_TAG }}/react-native-bb-player-${{ env.RELEASE_VERSION }}.tgz)

            ## Documentation
            - [README](https://github.com/bluebillywig/react-native-bb-player/blob/${{ env.RELEASE_TAG }}/README.md)
            - [CHANGELOG](https://github.com/bluebillywig/react-native-bb-player/blob/${{ env.RELEASE_TAG }}/CHANGELOG.md)
            - [Fullscreen Guide](https://github.com/bluebillywig/react-native-bb-player/blob/${{ env.RELEASE_TAG }}/FULLSCREEN.md)
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

  build-android-demo:
    name: Build Android demo app
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        working-directory: player-api-example
        run: npm ci

      - name: Prebuild Android project
        working-directory: player-api-example
        run: npx expo prebuild --platform android --clean

      - name: Build Android release APK
        working-directory: player-api-example/android
        run: ./gradlew assembleRelease --no-daemon

      - name: Rename APK with version
        run: |
          VERSION="${{ needs.create-release.outputs.release_version }}"
          mv player-api-example/android/app/build/outputs/apk/release/app-release.apk \
             player-api-example-${VERSION}.apk

      - name: Upload APK to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.release_tag }}
          files: ./player-api-example-${{ needs.create-release.outputs.release_version }}.apk
          token: ${{ secrets.GITHUB_TOKEN }}

  create-npm-package:
    name: Create npm package tarball
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.release_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create npm package
        run: |
          npm pack
          VERSION="${{ needs.create-release.outputs.release_version }}"
          # Ensure the file has the expected name (npm pack uses version from package.json)
          ACTUAL_FILE=$(ls react-native-bb-player-*.tgz)
          EXPECTED_FILE="react-native-bb-player-${VERSION}.tgz"
          if [ "$ACTUAL_FILE" != "$EXPECTED_FILE" ]; then
            mv "$ACTUAL_FILE" "$EXPECTED_FILE"
          fi

      - name: Upload package to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.release_tag }}
          files: ./react-native-bb-player-${{ needs.create-release.outputs.release_version }}.tgz
          token: ${{ secrets.GITHUB_TOKEN }}

  generate-docs:
    name: Generate documentation bundle
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.release_tag }}

      - name: Create documentation bundle
        run: |
          VERSION="${{ needs.create-release.outputs.release_version }}"
          mkdir -p docs-bundle
          cp README.md docs-bundle/
          cp CHANGELOG.md docs-bundle/
          cp FULLSCREEN.md docs-bundle/
          cp LICENSE docs-bundle/

          # Create a combined documentation file
          cat > docs-bundle/DOCUMENTATION.md << 'EOF'
          # react-native-bb-player Documentation

          Version: ${{ needs.create-release.outputs.release_version }}

          ## Contents

          - [README.md](README.md) - Getting started and API reference
          - [CHANGELOG.md](CHANGELOG.md) - Version history and changes
          - [FULLSCREEN.md](FULLSCREEN.md) - Fullscreen implementation guide
          - [LICENSE](LICENSE) - MIT License

          ## Quick Links

          - [GitHub Repository](https://github.com/bluebillywig/react-native-bb-player)
          - [npm Package](https://www.npmjs.com/package/react-native-bb-player)
          - [Issues](https://github.com/bluebillywig/react-native-bb-player/issues)
          - [Releases](https://github.com/bluebillywig/react-native-bb-player/releases)

          ## Native SDK Versions

          This version includes:
          - iOS: BlueBillywigNativePlayerKit-iOS ${{ needs.create-release.outputs.ios_sdk_version }}
          - Android: bbnativeplayersdk ${{ needs.create-release.outputs.android_sdk_version }}
          EOF

          # Create tarball
          tar -czf react-native-bb-player-docs-${VERSION}.tar.gz -C docs-bundle .

      - name: Upload documentation bundle to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.release_tag }}
          files: ./react-native-bb-player-docs-${{ needs.create-release.outputs.release_version }}.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Release summary
    needs: [create-release, build-android-demo, create-npm-package, generate-docs]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          # Check job statuses
          RELEASE_STATUS="${{ needs.create-release.result }}"
          ANDROID_STATUS="${{ needs.build-android-demo.result }}"
          NPM_STATUS="${{ needs.create-npm-package.result }}"
          DOCS_STATUS="${{ needs.generate-docs.result }}"

          # Determine overall status
          if [ "$RELEASE_STATUS" == "success" ] && [ "$ANDROID_STATUS" == "success" ] && [ "$NPM_STATUS" == "success" ] && [ "$DOCS_STATUS" == "success" ]; then
            echo "## âœ… Release ${{ needs.create-release.outputs.release_tag }} Created Successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Release ${{ needs.create-release.outputs.release_tag }} Completed with Issues" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`${{ needs.create-release.outputs.release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: \`${{ needs.create-release.outputs.release_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Release Assets Status" >> $GITHUB_STEP_SUMMARY

          # Android APK status
          if [ "$ANDROID_STATUS" == "success" ]; then
            echo "- âœ… Android demo APK" >> $GITHUB_STEP_SUMMARY
          elif [ "$ANDROID_STATUS" == "failure" ]; then
            echo "- âŒ Android demo APK (build failed)" >> $GITHUB_STEP_SUMMARY
          elif [ "$ANDROID_STATUS" == "skipped" ]; then
            echo "- â­ï¸ Android demo APK (skipped)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Android demo APK (status: $ANDROID_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          # npm package status
          if [ "$NPM_STATUS" == "success" ]; then
            echo "- âœ… npm package tarball" >> $GITHUB_STEP_SUMMARY
          elif [ "$NPM_STATUS" == "failure" ]; then
            echo "- âŒ npm package tarball (build failed)" >> $GITHUB_STEP_SUMMARY
          elif [ "$NPM_STATUS" == "skipped" ]; then
            echo "- â­ï¸ npm package tarball (skipped)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ npm package tarball (status: $NPM_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          # Documentation status
          if [ "$DOCS_STATUS" == "success" ]; then
            echo "- âœ… Documentation bundle" >> $GITHUB_STEP_SUMMARY
          elif [ "$DOCS_STATUS" == "failure" ]; then
            echo "- âŒ Documentation bundle (build failed)" >> $GITHUB_STEP_SUMMARY
          elif [ "$DOCS_STATUS" == "skipped" ]; then
            echo "- â­ï¸ Documentation bundle (skipped)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Documentation bundle (status: $DOCS_STATUS)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](https://github.com/bluebillywig/react-native-bb-player/releases/tag/${{ needs.create-release.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY

          if [ "$ANDROID_STATUS" == "success" ]; then
            echo "- [Download Demo APK](https://github.com/bluebillywig/react-native-bb-player/releases/download/${{ needs.create-release.outputs.release_tag }}/player-api-example-${{ needs.create-release.outputs.release_version }}.apk)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$NPM_STATUS" == "success" ]; then
            echo "- [Download npm Package](https://github.com/bluebillywig/react-native-bb-player/releases/download/${{ needs.create-release.outputs.release_tag }}/react-native-bb-player-${{ needs.create-release.outputs.release_version }}.tgz)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$DOCS_STATUS" == "success" ]; then
            echo "- [Download Documentation](https://github.com/bluebillywig/react-native-bb-player/releases/download/${{ needs.create-release.outputs.release_tag }}/react-native-bb-player-docs-${{ needs.create-release.outputs.release_version }}.tar.gz)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY

          if [ "$RELEASE_STATUS" == "success" ] && [ "$ANDROID_STATUS" == "success" ] && [ "$NPM_STATUS" == "success" ] && [ "$DOCS_STATUS" == "success" ]; then
            echo "1. Test the demo APK on Android devices" >> $GITHUB_STEP_SUMMARY
            echo "2. Optionally publish to npm: \`npm publish\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Announce the release to your team/customers" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. Review failed jobs above" >> $GITHUB_STEP_SUMMARY
            echo "2. Check job logs for error details" >> $GITHUB_STEP_SUMMARY
            echo "3. Fix issues and re-run failed jobs or create a new release" >> $GITHUB_STEP_SUMMARY
          fi
