name: Create release tag

on:
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set commit credentials
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Validate release branch
        run: |
          CURRENT_BRANCH="${GITHUB_REF##refs/heads/}"

          if [[ "$CURRENT_BRANCH" =~ ^release/v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            RELEASE_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
            RELEASE_BRANCH="release/v${RELEASE_VERSION}"
            echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
            echo "RELEASE_BRANCH=${RELEASE_BRANCH}" >> $GITHUB_ENV
            echo "Creating release from branch: $RELEASE_BRANCH"
          else
            echo "::error::Not on a release branch. Current branch: $CURRENT_BRANCH"
            echo "::error::This workflow must be run from a release/v{x}.{y}.{z} branch"
            exit 1
          fi

      - name: Check if tag already exists
        run: |
          RELEASE_TAG="v${{ env.RELEASE_VERSION }}"

          if git rev-parse "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "::error::Tag $RELEASE_TAG already exists"
            exit 1
          fi

          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV

      - name: Get previous tag for changelog
        run: |
          # Find the previous release tag
          PREV_TAG=$(git describe --tags --abbrev=0 --match='v*.*.*' 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # No previous tag, use first commit
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "FROM_TAG=${PREV_TAG}" >> $GITHUB_ENV
          echo "Generating changelog from: $PREV_TAG"

      - name: Extract changelog section
        id: changelog
        run: |
          # Extract the changelog section for this version
          VERSION="${{ env.RELEASE_VERSION }}"

          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d')

            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="See CHANGELOG.md for details"
            fi
          else
            CHANGELOG="Version $VERSION release"
          fi

          # Save to file to handle multiline
          echo "$CHANGELOG" > /tmp/changelog.txt

          echo "CHANGELOG_FILE=/tmp/changelog.txt" >> $GITHUB_ENV

      - name: Create tag
        run: |
          git tag "${{ env.RELEASE_TAG }}"
          git push origin "${{ env.RELEASE_TAG }}"
          echo "✅ Created and pushed tag: ${{ env.RELEASE_TAG }}"

      - name: Extract native SDK versions
        id: sdk_versions
        run: |
          # Extract iOS SDK version from podspec
          IOS_VERSION=$(grep "s.dependency 'BlueBillywigNativePlayerKit-iOS'" ReactNativeBBPlayer.podspec | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+")

          # Extract Android SDK version from build.gradle
          ANDROID_VERSION=$(grep "com.bluebillywig.bbnativeplayersdk:bbnativeplayersdk" android/build.gradle | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+")

          echo "IOS_SDK_VERSION=${IOS_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_SDK_VERSION=${ANDROID_VERSION}" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          release_name: 'Release ${{ env.RELEASE_VERSION }}'
          body: |
            ## react-native-bb-player ${{ env.RELEASE_VERSION }}

            $(cat ${{ env.CHANGELOG_FILE }})

            ## Native SDK Versions
            - **iOS**: BlueBillywigNativePlayerKit-iOS `${{ env.IOS_SDK_VERSION }}`
            - **Android**: bbnativeplayersdk `${{ env.ANDROID_SDK_VERSION }}`

            ## Installation

            ```bash
            npm install react-native-bb-player@${{ env.RELEASE_VERSION }}
            ```

            Or with specific version:

            ```json
            {
              "dependencies": {
                "react-native-bb-player": "${{ env.RELEASE_VERSION }}"
              }
            }
            ```

            ## Documentation
            - [README](https://github.com/bluebillywig/react-native-bb-player/blob/${{ env.RELEASE_TAG }}/README.md)
            - [CHANGELOG](https://github.com/bluebillywig/react-native-bb-player/blob/${{ env.RELEASE_TAG }}/CHANGELOG.md)
            - [Fullscreen Guide](https://github.com/bluebillywig/react-native-bb-player/blob/${{ env.RELEASE_TAG }}/FULLSCREEN.md)
          draft: false
          prerelease: false

      - name: Summary
        run: |
          echo "## ✅ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: \`${{ env.RELEASE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ env.RELEASE_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Native SDKs" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: \`${{ env.IOS_SDK_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Android: \`${{ env.ANDROID_SDK_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify the release on [GitHub Releases](https://github.com/bluebillywig/react-native-bb-player/releases)" >> $GITHUB_STEP_SUMMARY
          echo "2. Optionally publish to npm: \`npm publish\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Announce the release to your team/customers" >> $GITHUB_STEP_SUMMARY
